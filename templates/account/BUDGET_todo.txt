
					<h3>Payments</h3>

<?php // List of the payments
	if(isset($my_payments_per_bill[$bill['id']]) && is_array($my_payments_per_bill[$bill['id']])
		&& count($my_payments_per_bill[$bill['id']]) > 0)
	{
		$this_payment = $my_payments_per_bill[$bill['id']];
		$cpt_paymt = -1;
	?>
	
					<div class="row text-center">
						<div class="col-xs-4 col-md-2">
							<strong>Payer</strong>
						</div>
						<div class="col-xs-4 col-md-2">
							<strong>Amount</strong>
						</div>
						<div class="col-xs-4 col-md-2">
							<strong>Receiver</strong>
						</div>
						<div class="hidden-xs hidden-sm hidden-md col-lg-2">
							<strong>Designation</strong>
						</div>
						<div class="hidden-xs hidden-sm hidden-md col-lg-2">
							<strong>Date</strong>
						</div>
				<?php if($admin_mode && !$edit_mode){?>
						<div class="hidden-xs hidden-sm col-xs-1">
							<strong>Edit</strong>
						</div>
				<?php }if($admin_mode && !$edit_mode){?>
						<div class="hidden-xs hidden-sm col-xs-1">
							<strong>Delete</strong>
						</div>
				<?php }?>
					</div>
	
	<?php
	
$payment_to_edit = false; // if editing, place the payment after the other
foreach($this_payment as $payment)
{
	$cpt_paymt++;
		if($admin_mode && $edit_mode === 'payment' 
		&& $payment['hashid'] === $edit_hashid)
		{ 
			$payment_to_edit = $payment;
			continue;
		}
?>
					<div class="row payment_table">
						<div class="col-xs-5 col-md-2">
							<div class="fullwidth display_bdgt_participant padding_bdgt_participant" style="background-color:<?php echo '#'.$payment['payer_color']?>">
							<?php echo htmlspecialchars($payment['payer_name'])?>
							</div>
						</div>
						<div class="col-xs-2 col-md-2">
							 <?php echo (float)$payment['cost']?>&euro;
						</div>
						<div class="col-xs-5 col-md-2">
							<?php if(is_null($payment['receiver_name'])) {?>
							<div class="padding_bdgt_participant display_bdgt_participant group_color">
								Group
							</div>
							<?php }else{ ?>
							<div class="fullwidth display_bdgt_participant padding_bdgt_participant" style="background-color:<?php echo '#'.$payment['receiver_color']?>">			
								<?php echo htmlspecialchars($payment['receiver_name'])?>
							</div>
							<?php }?>
						</div>
						<div class="hidden-xs hidden-sm hidden-md col-lg-2 <?php echo 'description_collapse_'.$cpt_spreadsheet.'_'.$cpt_paymt?>">
							<?php if(!empty($payment['description']))
							{
									echo htmlspecialchars($payment['description']);
							}
							?>
						</div>
						<div class="hidden-xs hidden-sm hidden-md col-lg-2 <?php echo 'description_collapse_'.$cpt_spreadsheet.'_'.$cpt_paymt?>">
							<?php
							if(!empty($payment['date_of_payment']))
							{
								echo date("d/m/Y", strtotime($payment['date_of_payment']));
							}?>
						</div>
						<?php //Collapse button (for mobile>) ?>
						<div class="visible-xs visible-sm col-xs-2">
							<button type="submit" class="btn btn-default" title="Collapse/Expand"
								data-toggle="collapse" data-target=".<?php echo 'description_collapse_'.$cpt_spreadsheet.'_'.$cpt_paymt?>">
								<span class="glyphicon glyphicon-plus"></span>
							</button>
						</div>
		
	<?php //EDIT BUTTON
			if($admin_mode && !$edit_mode)
				{
	?>
						<div class="col-xs-2 col-md-1">
		<?php 
		$link_tmp = $link_to_account_admin.'/edit/payment/'.$payment['hashid'].'#edit_tag_'.$payment['hashid'];
		?>
							<form action="<?php echo $link_tmp ?>">
								<button type="submit" class="btn btn-default" title="Edit payment">
									<span class="glyphicon glyphicon-pencil"></span>
								</button>
							</form>
						</div>
						<div class="col-xs-2 col-md-1">
							<form method="post" 
								class="deleteicon"
								action="<?php echo ACTIONPATH.'/spreadsheets/budgets/bdgt_payments/delete_payment.php'?>"
									>
									<input type="hidden" name="p_hashid_account" value="<?php echo $my_account['hashid_admin']?>">
									<input type="hidden" name="p_hashid_payment" value="<?php echo $payment['hashid']?>">
									<input type="hidden" name="p_anchor" value="<?php echo '#bill-'.$cpt_spreadsheet?>">
									<button type="submit" class="btn btn-default confirmation" 
										name="submit_delete_payment" title="Delete payment">
										<span class="glyphicon glyphicon-trash"></span>
									</button>
								</form>
						</div>
		<?php
			}//end if admin + non edit 
			?>
					</div>
<?php	}//foreach current payment 

//Display payment to edit (if exists)
if($payment_to_edit !== false)
{
?>
					<div class="highlight" id="<?php echo 'edit_tag_'.$edit_hashid?>"
					style="background-color: rgba(<?php echo $cred.','.$cgreen.','.$cblue?>, 0.5);">
						<h3>Edit payment</h3>
						<form method="post" id="form_edit_payment_send"
							action="<?php echo ACTIONPATH.'/spreadsheets/budgets/bdgt_payments/update_payment.php'?>">
							<input type="hidden" name="p_hashid_account" value="<?php echo $my_account['hashid_admin']?>">
							<input type="hidden" name="p_hashid_payment" value="<?php echo $payment_to_edit['hashid']?>">
							<input type="hidden" name="p_anchor" value="<?php echo '#bill-'.$cpt_spreadsheet?>">
							
							<div class="row form-group">
								<div class="col-xs-12">
									<label for="form_edit_payment_bill_<?php echo $cpt_spreadsheet?>">
										Move to another bill
									</label>
									<div class="input-group">
										<select name="p_hashid_bill" id="form_edit_payment_bill_<?php echo $cpt_spreadsheet?>"
											onchange="CreatePossiblePayersLists(this, document.getElementById('form_edit_payment_payer_<?php echo $cpt_spreadsheet?>'),	
											<?php echo htmlspecialchars(json_encode($list_of_possible_payers, 3))?>)"
											class="form-control selectpicker"> 
								<?php //list of bills
										foreach($my_bills as $sub_bill)
											{
								?>
												<option value="<?php echo $sub_bill['hashid']?>"
												<?php if($sub_bill['id']==$payment_to_edit['bill_id']){echo ' selected';}?>
												><?php echo htmlspecialchars($sub_bill['title'])?></option>
								<?php
											}
								?>
										</select>
										<span class="input-group-addon glyphicon glyphicon-list"></span>
									</div>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-xs-12 col-lg-4">
									<label for="form_edit_payment_payer_<?php echo $cpt_spreadsheet?>">
										Payer
									</label>
									<div class="input-group">
										<select name="p_hashid_payer" 
											onchange="DropDownListsBetweenParticipants(this, document.getElementById('form_edit_payment_recv_<?php echo $bill['id']?>'))"
											id="form_edit_payment_payer_<?php echo $cpt_spreadsheet?>" class="form-control selectpicker">
								<?php
											foreach($this_bdgt_participants as $bdgt_participant)
											{
								?>
												<option value="<?php echo $bdgt_participant['hashid']?>"
												<?php if($bdgt_participant['id']==$payment_to_edit['payer_id']){echo ' selected';}?>>
												<?php echo htmlspecialchars($bdgt_participant['name'])?></option>
								<?php
											}
								?>
										</select>
										<span class="input-group-addon glyphicon glyphicon-user"></span>
									</div>
								</div>
								<div class="col-xs-12 col-lg-4">
									<label for="form_edit_payment_cost_<?php echo $cpt_spreadsheet?>">
										Amount
									</label>
									<div class="input-group">
										<input type="number" step="0.01" min="0" name="p_cost" 
											class="form-control"
											id="form_edit_payment_cost_<?php echo $cpt_spreadsheet?>"
											value="<?php echo (float)$payment_to_edit['cost']?>" required>
										<span class="input-group-addon glyphicon glyphicon-euro"></span>
									</div>
								</div>
								<div class="col-xs-12 col-lg-4">
									<label for="form_edit_payment_recv_<?php echo $cpt_spreadsheet?>">
										Receiver
									</label>
									<div class="input-group">
										<select name="p_hashid_recv" 
											id="form_edit_payment_recv_<?php echo $cpt_spreadsheet?>"
											class="form-control selectpicker">
											<option value="-1" >Group</option>
									<?php
											foreach($this_bdgt_participants as $bdgt_participant)
												{
													if($bdgt_participant['id'] == $payment_to_edit['payer_id']){continue;}
									?>
													<option value="<?php echo $bdgt_participant['hashid']?>"
													<?php if($bdgt_participant['id']==$payment_to_edit['receiver_id']){echo ' selected';}?>>
													<?php echo htmlspecialchars($bdgt_participant['name'])?></option>
									<?php
												}
									?>
										</select>
										<span class="input-group-addon glyphicon glyphicon-user"></span>
									</div>
								</div>
							</div>
							<div class="row form-group">
								<div class="col-xs-12 col-lg-6">
									<label for="form_edit_payment_desc_<?php echo $bill['id']?>">
										Description
									</label>
									<div class="input-group">
										<input type="text" name="p_description" class="form-control"
											id="form_edit_payment_desc_<?php echo $bill['id']?>"
											value="<?php echo htmlspecialchars($payment_to_edit['description'])?>"
											placeholder="Description">
										<span class="input-group-addon glyphicon glyphicon-tag"></span>
									</div>
								</div>
								<?php
									$tmp_date_parsed = date_parse($payment_to_edit['date_of_payment']);
									if ($tmp_date_parsed == false 
									|| !checkdate($tmp_date_parsed['month'], $tmp_date_parsed['day'], $tmp_date_parsed['year'])) 
									{
										$tmp_date_parsed = null;
									}else{
										$tmp_date_parsed=$tmp_date_parsed['day'].'/'.$tmp_date_parsed['month'].'/'.$tmp_date_parsed['year'];
									}
								?>
								<div class="col-xs-12 col-lg-6">
									<label for="form_edit_payment_date_<?php echo $bill['id']?>">
										Date of payment (dd/mm/yyyy)
									</label>
									<div class="input-group">
										<input type="text" name="p_date_of_payment" 
											class="form-control date_zindex"
											id="form_edit_payment_date_<?php echo $bill['id']?>"
											value="<?php echo $tmp_date_parsed?>">
										<span class="input-group-addon glyphicon glyphicon-calendar"></span>
									</div>
								</div>
								<?php $tmp_date_parsed = null;?>
							</div>
							<div>
								<button type="submit" name="submit_update_payment" value="Submit" 
									class="btn btn-primary" title="Update payment">
									Submit changes
								</button>
								<button type="submit" name="submit_cancel" 
									value="<?php echo '#bill-'.$cpt_spreadsheet?>" class="btn btn-primary"
									form="form_cancel" title="Cancel">
									Cancel
								</button>
							</div>
						</form>
					</div>
<?php
$payment_to_edit = false;
} //edit this payment
?>


<?php
}//if payment exist
else
{ 
	if(!empty($my_bdgt_participants[$bill['id']]))
	{?>
					<p>No payments recorded.</p>		
<?php
	}
	else
	{
	?>
					<p>Please provide participations to add payments.</p>			
<?php
		}
	}//end else payment exists
 // PAYMENTS
	if($admin_mode && !$edit_mode)
	{?>
	<!-- Add payment -->
	<?php
		if(!empty($my_bdgt_participants[$bill['id']]))
		{
?>
					<form method="post" action="<?php echo ACTIONPATH.'/spreadsheets/budgets/bdgt_payments/new_payment.php'?>"
						role="form">
						<fieldset>								
							<legend id="<?php echo 'show_hide_bill_add_paymt_'.$cpt_spreadsheet?>"
								class="cursorpointer">
								(+) Add a payment
							</legend>
							<div  class="hidden_at_first"	id="<?php echo 'show_hide_bill_add_paymt_'.$cpt_spreadsheet.'_target'?>">
								<div id="<?php echo 'div_option_add_payment_'.$cpt_spreadsheet?>">
									<p><em>Fields with asterisk <span class="glyphicon glyphicon-asterisk red"></span> are required</em></p>
									<input type="hidden" name="p_hashid_account" value ="<?php echo $my_account['hashid_admin']?>">
									<input type="hidden" name="p_hashid_bill" value ="<?php echo $bill['hashid']?>">
									<input type="hidden" name="p_anchor" value="<?php echo '#bill-'.$cpt_spreadsheet?>">
									<div id="div_set_payment_<?php echo $cpt_spreadsheet?>">
										<div class="row form-group">
											<div class="col-xs-12 col-lg-4">
												<label for="<?php echo 'form_set_payment_payer_'.$cpt_spreadsheet?>_0">Payer<span class="glyphicon glyphicon-asterisk red"></span></label>
												<div class="input-group">
													<select name="p_payment[0][p_hashid_payer]" 
														id="form_set_payment_payer_<?php echo $cpt_spreadsheet?>_0" 
														class="form-control selectpicker" title="Payer"> 
															<option disabled selected value="null" data-hidden="true">
																Choose a payer
															</option>
														<?php
															foreach($this_bdgt_participants as $bdgt_participant)
															{ ?>
																<option value="<?php echo $bdgt_participant['hashid']?>"><?php echo htmlspecialchars($bdgt_participant['name'])?></option>
											<?php	} ?>
													</select>
													<span class="input-group-addon glyphicon glyphicon-user"></span>
												</div>
											</div>

											<div class="col-xs-12 col-lg-4">
												<label for="<?php echo 'form_set_payment_cost_'.$cpt_spreadsheet?>_0">
													Amount<span class="glyphicon glyphicon-asterisk red"></span>
												</label>
												<div class="input-group">
													<input type="number" step="0.01" min="0" placeholder="Amount" name="p_payment[0][p_cost]" 
														id="<?php echo 'form_set_payment_cost_'.$cpt_spreadsheet?>_0" required 
														class="form-control" title="Amount">
													<span class="input-group-addon glyphicon glyphicon-euro"></span>
												</div>
											</div>
											<div class="col-xs-12 col-lg-4">
												<label for="<?php echo 'form_set_payment_type_'.$cpt_spreadsheet?>_0">
													Receiver(s)<span class="glyphicon glyphicon-asterisk red"></span>
												</label>
												<div class="input-group">
													<select name="p_payment[0][p_type]" id="<?php echo 'form_set_payment_type_'.$cpt_spreadsheet?>_0"	
														class="form-control selectpicker" title="Group or specific payment?"
														onchange="DisableEnableElement(this, document.getElementById('<?php echo 'form_set_payment_recv_'.$cpt_spreadsheet?>_0'))"> 
														<option value="-1" selected="selected">Entire Group</option>
														<option value="1">Specific</option>
													</select>
													<select name="p_payment[0][p_hashid_recv][]" id="<?php echo 'form_set_payment_recv_'.$cpt_spreadsheet?>_0"	
														class="form-control selectpicker" title="Receiver" multiple="multiple" disabled="disabled"> 
														<?php
															foreach($this_bdgt_participants as $bdgt_participant)
															{ ?>
																<option value="<?php echo $bdgt_participant['hashid']?>">
																	<?php echo htmlspecialchars($bdgt_participant['name'])?>
																</option>
												<?php	} ?>
													</select>
													<span class="input-group-addon glyphicon glyphicon-user"></span>
												</div>
											</div>
										</div>
										<div class="row form-group">
											<div class="col-xs-12 col-lg-6">
												<label for="<?php echo 'form_set_payment_desc_'.$cpt_spreadsheet?>_0">
													Description
												</label>
												<div class="input-group">
													<input type="text" name="p_payment[0][p_description]" 
														id="<?php echo 'form_set_payment_desc_'.$cpt_spreadsheet?>_0" 
														class="form-control" placeholder="Description" title="Description">
													<span class="input-group-addon glyphicon glyphicon-tag"></span>
												</div>
											</div>
											<div class="col-xs-12 col-lg-6">
												<label for="<?php echo 'form_set_payment_date_'.$cpt_spreadsheet?>_0">
													Date of payment (dd/mm/yyyy)
												</label>
												<div class="input-group">
													<input type="text" name="p_payment[0][p_date_of_payment]" 
														id="<?php echo 'form_set_payment_date_'.$cpt_spreadsheet?>_0" 
														class="form-control" title="Date of payment">
													<span class="input-group-addon glyphicon glyphicon-calendar"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
	<?php
		$name_of_people = array_column($this_bdgt_participants, 'name');
		$hashid_of_people = array_column($this_bdgt_participants, 'hashid');
	?>
								
								<div>
									<button type="submit" name="submit_new_payment" value="Submit" 
										title="Submit new payment" class="btn btn-primary">
										Submit
									</button>
									<button type="button" name="add_row"
										title="Add a row" class="btn btn-primary" 
										onclick="AddPaymentLine(<?php echo htmlspecialchars(json_encode($name_of_people)) ?>, 
										<?php echo htmlspecialchars(json_encode($hashid_of_people)) ?>,
										<?php echo $cpt_spreadsheet?>);return false;">
										Add a row
									</button>
								</div>
							</div>
						</fieldset>
					</form>
<?php
		}//if bdgt_participants not empty (ie: payment possible)
?>
	<?php
	} //if for displaying possibilities
?>